<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Utility</title>
    <link rel="stylesheet" href="./styles.css">
</head>

<body>
    <h1>Research Utility</h1>
    <div class="main">
         <div class="pdf-content">
            <div class="upload">
                <input type="file" id="inpFile">
                <button type="button" id="btnUpload">Upload</button>
            </div>
            <div class="row-select">
                <input id="number" type="number" min="0">
                <button type="button" id="btnRow">Submit</button>
            </div>
            <div class="pdf-display">
                <textarea id="resultText"></textarea>
            </div>
         </div>
         <div class="selected-area">
            <div class="button-area">
               <button type="button" id="btnClear">Clear</button>
               <button type="button" id="btnDownload">Download</button>
            </div>
            <div class="selected"></div>
         </div>
    </div>
    <button id="btnAdd">+</button>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <script>
        const inpFile = document.getElementById("inpFile");
        const btnUpload = document.getElementById("btnUpload");
        const resultText = document.getElementById("resultText");
        const btnAdd = document.getElementById("btnAdd");
        const selected = document.querySelector(".selected");
        const btnClear = document.getElementById("btnClear");
        const btnDownload = document.getElementById("btnDownload");
        const btnSend = document.getElementById("btnSend");
        let rowid = document.getElementById("number");
        const btnRow = document.getElementById("btnRow");
        let data;
        let row;

        
        
        btnUpload.addEventListener("click", () => {
            Papa.parse(document.getElementById('inpFile').files[0],{
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results){
                    data = results;
                    console.log(data)
                }
            });
        });
         
        btnRow.addEventListener("click", () => {
            row = rowid.value;
            resultText.value = data.data[row].text
        });

        
        let selectedText;
        let selectedArray = [];
        
        resultText.addEventListener("mouseup", (e) => {
          selectedText = "";
          selectedText = window.getSelection().toString().trim();
          if (selectedText.length) {
            const x = e.clientX;
            const y = e.clientY;
            const btnAddWidth = Number(getComputedStyle(btnAdd).width.slice(0, -2));
            const btnAddHeight = Number(getComputedStyle(btnAdd).height.slice(0, -2));
            btnAdd.style.left = `${x}px`;
            btnAdd.style.top = `${y}px`;
            btnAdd.style.display = "block";
          }
        });
        
        btnAdd.addEventListener("click", () => {
          const node = document.createElement("li");
          const textnode = document.createTextNode(selectedText.toString());
          node.appendChild(textnode);
          selected.appendChild(node);
          selectedArray.push(selectedText.toString());
        });
        
        document.addEventListener("mousedown", (e) => {
          if (getComputedStyle(btnAdd).display === "block" && e.target.id != "btnAdd") {
            btnAdd.style.display = "none";
            window.getSelection().empty();
          }
        });
        
        btnClear.addEventListener("click", () => {
          selectedArray = [];
          while (selected.lastElementChild) {
            selected.removeChild(selected.lastElementChild);
          }
        });
        
        function download(content, fileName, contentType) {
          const a = document.createElement("a");
          const file = new Blob([content], { type: contentType });
          a.href = URL.createObjectURL(file);
          a.download = fileName;
          a.click();
        }
        
        btnDownload.addEventListener("click", () => {
          download(JSON.stringify(selectedArray), `${row}.json`, "text/plain");
        });
        
    </script>
</body>
</html>